\hypertarget{class_storage}{}\section{Storage Class Reference}
\label{class_storage}\index{Storage@{Storage}}


Class for storing \& retrieving data on the logging device.  




{\ttfamily \#include $<$Storage.\+h$>$}

\subsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
void \hyperlink{class_storage_a98b01eb20a64a4bf4127685147f7f6f1}{init} ()
\begin{DoxyCompactList}\small\item\em Initialisation function for storage module. \end{DoxyCompactList}\item 
bool \hyperlink{class_storage_a044a17325b2917afca49aa19ddb488f6}{save\+To\+File} (char data\mbox{[}$\,$\mbox{]}, bool new\+Line)
\begin{DoxyCompactList}\small\item\em Saves a single line of data to a file. \end{DoxyCompactList}\item 
bool \hyperlink{class_storage_a571ce9630665d9407ffbaeff55c47b0a}{generate\+File\+Name} ()
\begin{DoxyCompactList}\small\item\em Generates a new filename to use for saving. \end{DoxyCompactList}\item 
void \hyperlink{class_storage_a4831b2e8ecfa22da6971f5a8690cc4e3}{load\+Trip\+Names} ()
\begin{DoxyCompactList}\small\item\em Loads the information of all trips and sends them over bluetooth. \end{DoxyCompactList}\item 
void \hyperlink{class_storage_af56ca8289ed925300e3385114c561eec}{load\+Saved\+Trip} ()
\begin{DoxyCompactList}\small\item\em Loads a saved trip and sends data to client via Serial. \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Private Attributes}
\begin{DoxyCompactItemize}
\item 
\mbox{\Hypertarget{class_storage_a7c3e886a0b8395c2045ab4f7e04481e1}\label{class_storage_a7c3e886a0b8395c2045ab4f7e04481e1}} 
char \hyperlink{class_storage_a7c3e886a0b8395c2045ab4f7e04481e1}{file\+Name} \mbox{[}30\mbox{]}
\begin{DoxyCompactList}\small\item\em File name to use when saving data. \end{DoxyCompactList}\item 
\mbox{\Hypertarget{class_storage_a14a7ad7e46c7cd5983344b81fed4265f}\label{class_storage_a14a7ad7e46c7cd5983344b81fed4265f}} 
Static\+Json\+Buffer$<$ 200 $>$ \hyperlink{class_storage_a14a7ad7e46c7cd5983344b81fed4265f}{json\+File\+Buffer}
\begin{DoxyCompactList}\small\item\em Allocated space for holding J\+S\+ON objects within. \end{DoxyCompactList}\item 
\mbox{\Hypertarget{class_storage_ac503241aaa812f9b8ee36dd10cbd915a}\label{class_storage_ac503241aaa812f9b8ee36dd10cbd915a}} 
Json\+Object \& \hyperlink{class_storage_ac503241aaa812f9b8ee36dd10cbd915a}{file\+J\+S\+ON} = json\+File\+Buffer.\+create\+Object()
\begin{DoxyCompactList}\small\item\em J\+S\+ON object that holds file information (size + name) \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
Class for storing \& retrieving data on the logging device. 

\subsection{Member Function Documentation}
\mbox{\Hypertarget{class_storage_a98b01eb20a64a4bf4127685147f7f6f1}\label{class_storage_a98b01eb20a64a4bf4127685147f7f6f1}} 
\index{Storage@{Storage}!init@{init}}
\index{init@{init}!Storage@{Storage}}
\subsubsection{\texorpdfstring{init()}{init()}}
{\footnotesize\ttfamily void Storage\+::init (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



Initialisation function for storage module. 

Responsible for starting the u\+SD library. 

References U\+S\+D\+\_\+\+CS.


\begin{DoxyCode}
38 \{
39   SD.begin(\hyperlink{_storage_8cpp_abe774366dbdfb2de4e34e4f07843db38}{USD\_CS});
40 \}
\end{DoxyCode}
\mbox{\Hypertarget{class_storage_a044a17325b2917afca49aa19ddb488f6}\label{class_storage_a044a17325b2917afca49aa19ddb488f6}} 
\index{Storage@{Storage}!save\+To\+File@{save\+To\+File}}
\index{save\+To\+File@{save\+To\+File}!Storage@{Storage}}
\subsubsection{\texorpdfstring{save\+To\+File()}{saveToFile()}}
{\footnotesize\ttfamily bool Storage\+::save\+To\+File (\begin{DoxyParamCaption}\item[{char}]{data\mbox{[}$\,$\mbox{]},  }\item[{bool}]{new\+Line }\end{DoxyParamCaption})}



Saves a single line of data to a file. 

Opens a handle to the current file\+Name. If the file exists data is appended, if not the file is created first.


\begin{DoxyParams}{Parameters}
{\em data} & -\/ Character array of data to save. \\
\hline
{\em new\+Line} & -\/ Whether to add new line character at end of line. \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
bool -\/ Whether saving was a success. 
\end{DoxyReturn}


References file\+Name.


\begin{DoxyCode}
53 \{
54   \textcolor{keywordtype}{bool} result = \textcolor{keyword}{false};
55 
56   \textcolor{comment}{/* Create handle to log file */}
57   File logHandle = SD.open(\hyperlink{class_storage_a7c3e886a0b8395c2045ab4f7e04481e1}{fileName}, FILE\_WRITE);
58 
59   \textcolor{comment}{/* If handle exists print line to file */}
60   \textcolor{keywordflow}{if} (logHandle)
61   \{
62 
63     \textcolor{comment}{/* Print line, option to add newline characters */}
64     logHandle.print(data);
65     \textcolor{keywordflow}{if} (newLine)
66     \{
67       logHandle.println();
68     \}
69 
70     logHandle.close();
71     result = \textcolor{keyword}{true};
72   \}
73   \textcolor{keywordflow}{return} result;
74 \}
\end{DoxyCode}
\mbox{\Hypertarget{class_storage_a571ce9630665d9407ffbaeff55c47b0a}\label{class_storage_a571ce9630665d9407ffbaeff55c47b0a}} 
\index{Storage@{Storage}!generate\+File\+Name@{generate\+File\+Name}}
\index{generate\+File\+Name@{generate\+File\+Name}!Storage@{Storage}}
\subsubsection{\texorpdfstring{generate\+File\+Name()}{generateFileName()}}
{\footnotesize\ttfamily bool Storage\+::generate\+File\+Name (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



Generates a new filename to use for saving. 

Searches through existing files using pattern P\+R\+E\+F\+I\+X\+\_\+\+I\+D.\+S\+U\+F\+F\+IX ~\newline
Existing files are skipped, once non-\/existant is found that is used.

\begin{DoxyReturn}{Returns}
bool -\/ Whether a valid file name was able to be found. 
\end{DoxyReturn}


References file\+Name, L\+O\+G\+\_\+\+E\+X\+T\+E\+N\+S\+I\+ON, L\+O\+G\+\_\+\+N\+A\+ME, and M\+A\+X\+\_\+\+L\+O\+G\+\_\+\+F\+I\+L\+ES.


\begin{DoxyCode}
85 \{
86   \textcolor{keywordtype}{bool} result = \textcolor{keyword}{false};
87   \textcolor{keywordtype}{int} i = 0;
88 
89   \textcolor{keywordflow}{for} (i = 0; i < \hyperlink{_storage_8cpp_a777ac288f17a847a5ce37bf9a89a0037}{MAX\_LOG\_FILES}; i++)
90   \{
91     \textcolor{comment}{/* Clear name of log file */}
92     memset(\hyperlink{class_storage_a7c3e886a0b8395c2045ab4f7e04481e1}{fileName}, 0, strlen(\hyperlink{class_storage_a7c3e886a0b8395c2045ab4f7e04481e1}{fileName}));
93 
94     \textcolor{comment}{/* Set the new log file name to: trip\_XXXXX.json */}
95     sprintf(\hyperlink{class_storage_a7c3e886a0b8395c2045ab4f7e04481e1}{fileName}, \textcolor{stringliteral}{"%s%d.%s"}, \hyperlink{_storage_8cpp_abbd544044b4167ca397bfb6e3073aa50}{LOG\_NAME}, i, \hyperlink{_storage_8cpp_a907e440e32d31fd828188004703e3178}{LOG\_EXTENSION});
96 
97     \textcolor{keywordflow}{if} (!SD.exists(\hyperlink{class_storage_a7c3e886a0b8395c2045ab4f7e04481e1}{fileName}))
98     \{
99       \textcolor{comment}{/* If a file doesn't exist */}
100       result = \textcolor{keyword}{true};
101       \textcolor{keywordflow}{break};
102     \}
103   \}
104 
105   \textcolor{keywordflow}{return} result;
106 \}
\end{DoxyCode}
\mbox{\Hypertarget{class_storage_a4831b2e8ecfa22da6971f5a8690cc4e3}\label{class_storage_a4831b2e8ecfa22da6971f5a8690cc4e3}} 
\index{Storage@{Storage}!load\+Trip\+Names@{load\+Trip\+Names}}
\index{load\+Trip\+Names@{load\+Trip\+Names}!Storage@{Storage}}
\subsubsection{\texorpdfstring{load\+Trip\+Names()}{loadTripNames()}}
{\footnotesize\ttfamily void Storage\+::load\+Trip\+Names (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



Loads the information of all trips and sends them over bluetooth. 

Searches directory for trips, then sends trip\textquotesingle{}s name \& size over serial. 

References B\+T\+\_\+\+S\+E\+R\+I\+AL, and file\+J\+S\+ON.


\begin{DoxyCode}
114 \{
115   \textcolor{keywordtype}{bool} filesRemaining = \textcolor{keyword}{true};
116 
117   File root = SD.open(\textcolor{stringliteral}{"/"});
118 
119   \textcolor{comment}{/* Try to open directory for logs */}
120   \textcolor{keywordflow}{if} (root)
121   \{
122     \textcolor{comment}{/* Ensure starting from start of directory */}
123     root.rewindDirectory();
124 
125     \textcolor{keywordflow}{while} (filesRemaining == \textcolor{keyword}{true})
126     \{
127       \textcolor{comment}{/* Try open handle for next file */}
128       File entry = root.openNextFile();
129       \textcolor{keywordflow}{if} (entry)
130       \{
131         \textcolor{keywordflow}{if} (entry.isDirectory() == \textcolor{keyword}{false})
132         \{
133           \textcolor{comment}{/* Print out file name & size */}
134           \hyperlink{class_storage_ac503241aaa812f9b8ee36dd10cbd915a}{fileJSON}[\textcolor{stringliteral}{"name"}] = entry.name();
135           \hyperlink{class_storage_ac503241aaa812f9b8ee36dd10cbd915a}{fileJSON}[\textcolor{stringliteral}{"size"}] = entry.size();
136 
137           \hyperlink{class_storage_ac503241aaa812f9b8ee36dd10cbd915a}{fileJSON}.printTo(\hyperlink{_storage_8cpp_ad1e6e6f6fc813b305067b9e1b0777ea6}{BT\_SERIAL});
138           \hyperlink{_storage_8cpp_ad1e6e6f6fc813b305067b9e1b0777ea6}{BT\_SERIAL}.println();
139         \}
140         entry.close();
141       \}
142       \textcolor{keywordflow}{else}
143       \{
144         \textcolor{comment}{/* No more files remaining in directory */}
145         filesRemaining = \textcolor{keyword}{false};
146       \}
147     \}
148 
149     root.close();
150   \}
151 \}
\end{DoxyCode}
\mbox{\Hypertarget{class_storage_af56ca8289ed925300e3385114c561eec}\label{class_storage_af56ca8289ed925300e3385114c561eec}} 
\index{Storage@{Storage}!load\+Saved\+Trip@{load\+Saved\+Trip}}
\index{load\+Saved\+Trip@{load\+Saved\+Trip}!Storage@{Storage}}
\subsubsection{\texorpdfstring{load\+Saved\+Trip()}{loadSavedTrip()}}
{\footnotesize\ttfamily void Storage\+::load\+Saved\+Trip (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



Loads a saved trip and sends data to client via Serial. 

Waits for the filename to be received via serial. Once file name is received, procedure attempts to open the file. If the file exists it then sends all bytes in the file via Serial. 

References B\+T\+\_\+\+S\+E\+R\+I\+AL, and L\+O\+G\+\_\+\+E\+X\+T\+E\+N\+S\+I\+ON.


\begin{DoxyCode}
161 \{
162   \textcolor{keywordtype}{bool} nameComplete = \textcolor{keyword}{false};
163   String fileToOpen = \textcolor{stringliteral}{""};
164 
165   \textcolor{keywordflow}{while} (nameComplete == \textcolor{keyword}{false})
166   \{
167     \textcolor{comment}{/* Keep reading input in serial until file name is found */}
168     \textcolor{keywordflow}{if} (\hyperlink{_storage_8cpp_ad1e6e6f6fc813b305067b9e1b0777ea6}{BT\_SERIAL}.available() > 0)
169     \{
170       \textcolor{keywordtype}{char} recvByte = \hyperlink{_storage_8cpp_ad1e6e6f6fc813b305067b9e1b0777ea6}{BT\_SERIAL}.read();
171       fileToOpen += recvByte;
172 
173       \textcolor{comment}{/* Wait until extension is found, then we know full file name */}
174       \textcolor{keywordflow}{if} (fileToOpen.endsWith(\hyperlink{_storage_8cpp_a907e440e32d31fd828188004703e3178}{LOG\_EXTENSION}))
175       \{
176         nameComplete = \textcolor{keyword}{true};
177       \}
178     \}
179   \}
180 
181   \textcolor{comment}{/* Check if file exists */}
182   \textcolor{keywordflow}{if} (SD.exists(fileToOpen))
183   \{
184     \textcolor{comment}{/* Open file, then read out data byte by byte */}
185     File handle = SD.open(fileToOpen);
186     \textcolor{keywordflow}{if} (handle)
187     \{
188 
189       \textcolor{keywordflow}{while} (handle.available())
190       \{
191         \textcolor{keywordtype}{char} readByte = handle.read();
192 
193         \hyperlink{_storage_8cpp_ad1e6e6f6fc813b305067b9e1b0777ea6}{BT\_SERIAL}.write(readByte);
194       \}
195 
196       handle.close();
197     \}
198   \}
199 \}
\end{DoxyCode}


The documentation for this class was generated from the following files\+:\begin{DoxyCompactItemize}
\item 
logging-\/device/Storage.\+h\item 
logging-\/device/\hyperlink{_storage_8cpp}{Storage.\+cpp}\end{DoxyCompactItemize}
